name: Auto Rollback on Failure

on:
  workflow_run:
    workflows: ["Deploy Multi-Environment"]
    types: [completed]

jobs:
  check-deployment:
    name: Check Deployment Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get deployment environment
        id: env
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          
          case $BRANCH in
            main)
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "url=https://api.memodrops.com" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "url=https://api-staging.memodrops.com" >> $GITHUB_OUTPUT
              ;;
            develop)
              echo "environment=development" >> $GITHUB_OUTPUT
              echo "url=https://api-dev.memodrops.com" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Check if rollback is needed
        id: check
        run: |
          URL="${{ steps.env.outputs.url }}/health"
          
          echo "ğŸ¥ Checking health at: $URL"
          
          # Try 3 times
          for i in {1..3}; do
            if curl -f -s "$URL" > /dev/null; then
              echo "âœ… Service is healthy, no rollback needed"
              echo "rollback_needed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Attempt $i/3 failed..."
            sleep 10
          done
          
          echo "âŒ Service is unhealthy, rollback needed!"
          echo "rollback_needed=true" >> $GITHUB_OUTPUT

      - name: Trigger rollback
        if: steps.check.outputs.rollback_needed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-multi-env.yml',
              ref: '${{ github.event.workflow_run.head_branch }}',
              inputs: {
                environment: '${{ steps.env.outputs.environment }}',
                rollback: 'true'
              }
            });
            
            console.log('ğŸ”„ Rollback triggered:', result);

      - name: Send alert
        if: steps.check.outputs.rollback_needed == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                â•‘"
          echo "â•‘   âš ï¸  AUTO ROLLBACK TRIGGERED! âš ï¸             â•‘"
          echo "â•‘                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Reason: Health check failed"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "Action: Rolling back to previous version..."
